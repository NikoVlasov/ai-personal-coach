<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Personal Coach - MVP</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
#app-container { width: 420px; min-height: 700px; background: #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; }
header { background-color: #4f8ef7; color: white; text-align: center; font-size: 1.5em; font-weight: bold; padding: 15px; }
.hidden { display: none; }

#top-buttons { display:flex; justify-content:flex-end; gap:8px; padding:10px; }
.top-btn { padding:6px 12px; border:none; border-radius:8px; background:#4f8ef7; color:white; cursor:pointer; transition:none; }
.top-btn.active { background:#3a6fdc; }

#auth-container { padding: 20px; display:flex; flex-direction:column; align-items:center; }
.auth-tabs { display: flex; justify-content: center; margin-bottom: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width:100%; }
.auth-tabs button { flex: 1; padding: 12px; border: none; cursor: pointer; background: #e6edf7; font-weight: bold; transition: background 0.3s, color 0.3s; }
.auth-tabs button.active { background: #4f8ef7; color: white; }
.auth-form { display: flex; flex-direction: column; gap: 12px; transition: opacity 0.3s ease, transform 0.3s ease; width:100%; margin:0; }
.auth-form.hidden { opacity: 0; transform: translateY(-10px); pointer-events: none; }
.auth-form input { padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; width:100%; }
.auth-form button { padding: 12px; border-radius: 8px; border: none; background: #4f8ef7; color: white; font-weight: bold; cursor: pointer; transition: background 0.3s, transform 0.2s; width:100%; }
.auth-form button:hover { background: #3a6fdc; transform: scale(1.03); }

#new-chat { display:flex; gap:6px; padding:10px; }
#new-chat input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
#new-chat button { padding:8px 12px; border-radius:8px; border:none; background:#4f8ef7; color:white; font-weight:bold; cursor:pointer; transition:0.2s; }
#new-chat button:hover { background:#3a6fdc; transform:scale(1.05); }

#chat-select { width: calc(100% - 20px); margin: 10px; padding: 10px; border-radius: 12px; font-size: 1em; background: #f7faff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #ccc; }
#delete-chat-btn { margin:5px 10px; background:#f54242; color:white; border:none; border-radius:8px; padding:8px; cursor:pointer; transition: 0.2s; }
#delete-chat-btn:hover { background:#d13030; transform: scale(1.05); }

#chat-container { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #e6edf7; max-height: 400px; }
.message { max-width: 75%; padding: 10px 15px; border-radius: 15px; line-height: 1.4; word-wrap: break-word; animation: fadeIn 0.3s ease-in; }
.user { background: #4f8ef7; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
.ai { background: #fff; color: #333; align-self: flex-start; border: 1px solid #ccc; border-bottom-left-radius: 0; }

#input-container { display:flex; gap:5px; padding:10px; }
#input-container input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
#input-container button { padding:8px 12px; border-radius:8px; border:none; background:#4f8ef7; color:white; font-weight:bold; cursor:pointer; }
#input-container button:hover { background:#3a6fdc; transform:scale(1.05); }
</style>
</head>
<body>
<div id="app-container">
  <header>AI Personal Coach</header>

  <div id="top-buttons">
      <button id="btn-ru" class="top-btn active" onclick="setLanguage('ru')">RU</button>
      <button id="btn-en" class="top-btn" onclick="setLanguage('en')">EN</button>
      <button id="btn-logout" class="top-btn" onclick="mainModule.logout()">Logout</button>
  </div>

  <div id="auth-container">
      <div class="auth-tabs">
          <button id="login-tab" class="active" onclick="authModule.showForm('login')">Вход</button>
          <button id="register-tab" onclick="authModule.showForm('register')">Регистрация</button>
      </div>
      <form id="login-form" class="auth-form">
          <input type="email" id="login-email" placeholder="Email" required>
          <input type="password" id="login-password" placeholder="Пароль" required>
          <button type="button" onclick="authModule.login()">Войти</button>
      </form>
      <form id="register-form" class="auth-form hidden">
          <input type="email" id="register-email" placeholder="Email" required>
          <input type="password" id="register-password" placeholder="Пароль" required>
          <button type="button" onclick="authModule.register()">Зарегистрироваться</button>
      </form>
  </div>

  <div id="chat-ui" class="hidden">
      <div id="new-chat">
          <input type="text" id="new-chat-title" placeholder="Название нового чата...">
          <button onclick="chatModule.createChat()">+</button>
      </div>

      <select id="chat-select" onchange="chatModule.selectChat()">
          <option value="">Выберите чат</option>
      </select>
      <button id="delete-chat-btn" onclick="chatModule.deleteChat()">Удалить чат</button>

      <div id="chat-container"></div>

      <div id="input-container">
          <input type="text" id="message-input" placeholder="Напиши сообщение...">
          <button onclick="chatModule.sendMessage()">Отправить</button>
      </div>
  </div>
</div>

<script>
const BASE_URL = window.location.hostname.includes("onrender.com")
  ? "https://ai-personal-coach-rogv.onrender.com"
  : "http://127.0.0.1:8000";

let currentLanguage = 'ru';
let currentChatId = null;
let token = localStorage.getItem("token") || null;

// --- UI Helper ---
const show = (id) => document.getElementById(id).classList.remove("hidden");
const hide = (id) => document.getElementById(id).classList.add("hidden");

// --- Language Switcher ---
function setLanguage(lang) {
  currentLanguage = lang;
  document.getElementById("btn-ru").classList.toggle("active", lang === "ru");
  document.getElementById("btn-en").classList.toggle("active", lang === "en");
}

// --- Auth Module ---
const authModule = {
  showForm(type) {
    const loginForm = document.getElementById("login-form");
    const regForm = document.getElementById("register-form");
    document.getElementById("login-tab").classList.toggle("active", type === "login");
    document.getElementById("register-tab").classList.toggle("active", type === "register");
    loginForm.classList.toggle("hidden", type !== "login");
    regForm.classList.toggle("hidden", type !== "register");
  },
  async login() {
    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value.trim();
    const res = await fetch(`${BASE_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    if (res.ok) {
      const data = await res.json();
      localStorage.setItem("token", data.access_token);
      token = data.access_token;
      mainModule.loadChats();
      hide("auth-container");
      show("chat-ui");
    } else alert("Ошибка входа");
  },
  async register() {
    const email = document.getElementById("register-email").value.trim();
    const password = document.getElementById("register-password").value.trim();
    const res = await fetch(`${BASE_URL}/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    if (res.ok) alert("Регистрация успешна!");
    else alert("Ошибка регистрации");
  }
};

// --- Chat Module ---
const chatModule = {
  async loadChats() {
    const res = await fetch(`${BASE_URL}/chats`, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) return alert("Ошибка при получении чатов");
    const chats = await res.json();
    const select = document.getElementById("chat-select");
    select.innerHTML = '<option value="">Выберите чат</option>';
    chats.forEach(chat => {
      const opt = document.createElement("option");
      opt.value = chat.id;
      opt.textContent = chat.title;
      select.appendChild(opt);
    });
  },
  async createChat() {
    const title = document.getElementById("new-chat-title").value.trim();
    if (!title) return alert("Введите название чата");
    const res = await fetch(`${BASE_URL}/chats`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({ title })
    });
    if (res.ok) {
      document.getElementById("new-chat-title").value = "";
      this.loadChats();
    } else alert("Ошибка при создании чата");
  },
  async selectChat() {
    const select = document.getElementById("chat-select");
    currentChatId = select.value;
    document.getElementById("chat-container").innerHTML = "";
  },
  async sendMessage() {
    const input = document.getElementById("message-input");
    const text = input.value.trim();
    if (!text || !currentChatId) return;
    const container = document.getElementById("chat-container");
    const msg = document.createElement("div");
    msg.className = "message user";
    msg.textContent = text;
    container.appendChild(msg);
    input.value = "";

    const res = await fetch(`${BASE_URL}/chat/${currentChatId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({ message: text, language: currentLanguage })
    });
    if (res.ok) {
      const data = await res.json();
      const reply = document.createElement("div");
      reply.className = "message ai";
      reply.textContent = data.response;
      container.appendChild(reply);
      container.scrollTop = container.scrollHeight;
    } else alert("Ошибка при отправке сообщения");
  },
  async deleteChat() {
    if (!currentChatId) return alert("Выберите чат для удаления");
    if (!confirm("Удалить этот чат?")) return;
    const res = await fetch(`${BASE_URL}/chats/${currentChatId}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
    if (res.ok) {
      alert("Чат удалён");
      this.loadChats();
      document.getElementById("chat-container").innerHTML = "";
    } else alert("Ошибка при удалении");
  }
};

// --- Main Module ---
const mainModule = {
  async loadChats() {
    hide("auth-container");
    show("chat-ui");
    await chatModule.loadChats();
  },
  logout() {
    localStorage.removeItem("token");
    token = null;
    hide("chat-ui");
    show("auth-container");
  }
};

// --- Auto-login if token exists ---
if (token) mainModule.loadChats();
</script>
</body>
</html>
