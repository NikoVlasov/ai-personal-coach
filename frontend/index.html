<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>AI Mentor – Your Personal AI Coach</title>

<meta name="description" content="AI Mentor is your personal AI coach to help you grow, stay motivated, and improve your daily routines.">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

<style>
/* --- root / vars --- */
:root {
  --vh: 1vh;
  --app-width: 420px;
  --primary: #4f8ef7;
}

/* Basic layout */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #f0f4f8;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

/* App container uses dynamic height based on --vh */
#app-container {
  width: var(--app-width);
  max-width: 100%;
  height: calc(var(--vh, 1vh) * 100);
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin: 10px auto;
  box-sizing: border-box;
}

/* Header */
header {
  background-color: var(--primary);
  color: white;
  text-align: center;
  font-size: 1.1rem;
  font-weight: 700;
  padding: 12px 16px;
  flex-shrink: 0;
}

/* Top buttons */
#top-buttons { display:flex; justify-content:flex-end; gap:8px; padding:8px 10px; }
.top-btn { padding:6px 12px; border:none; border-radius:8px; background:var(--primary); color:white; cursor:pointer; }

/* Auth container */
#auth-container { padding: 12px; display:flex; flex-direction: column; gap:10px; box-sizing: border-box; }
.auth-tabs { display:flex; gap:8px; }
.auth-tabs button { flex:1; padding:10px; border-radius:8px; border:none; background:#e6edf7; font-weight:700; cursor:pointer; }
.auth-tabs button.active { background:var(--primary); color:#fff; }

/* Chat UI */
#chat-ui { display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }

/* Chat dropdown */
#chat-dropdown-container { padding: 10px; }
#chat-dropdown-btn { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ccc; background: #f7faff; text-align: left; display:flex; justify-content:space-between; align-items:center; cursor:pointer; box-sizing:border-box; }
#chat-list { position: relative; margin-top:6px; background:#f7faff; border-radius:8px; max-height:0; overflow:hidden; transition: all .25s ease; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
#chat-list.show { max-height: 220px; overflow-y:auto; padding:6px; }

/* main chat area — flexible */
.chat-area {
  display:flex;
  flex-direction:column;
  flex: 1 1 auto;
  min-height: 0; /* important for flexbox + overflow children */
}

/* chat messages container (scrollable) */
.chat-container {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 10px;
  display:flex;
  flex-direction:column;
  gap: 8px;
  -webkit-overflow-scrolling: touch;
  background: #e6edf7;
  box-sizing: border-box;
}

/* message bubbles */
.message { max-width: 75%; padding: 10px 14px; border-radius: 14px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap; }
.user { align-self: flex-end; background: var(--primary); color:#fff; border-bottom-right-radius:4px; }
.ai { align-self: flex-start; background:#fff; color:#333; border:1px solid #ddd; border-bottom-left-radius:4px; }

/* quick buttons (above input) */
#quick-buttons { display:flex; gap:8px; flex-wrap:wrap; padding:8px; background: #f0f4fb; border-top:1px solid #e0e6ef; box-sizing:border-box; }

/* input area pinned with sticky (better than fixed for iOS) */
#input-wrapper {
  position: sticky;
  bottom: env(safe-area-inset-bottom, 0);
  background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,1));
  flex-shrink: 0;
  box-sizing: border-box;
}
#input-container {
  display:flex;
  gap:8px;
  padding: 10px;
  align-items: center;
  background: #fff;
  border-top: 1px solid #e6eaf3;
  box-sizing: border-box;
  padding-bottom: calc(env(safe-area-inset-bottom, 0) + 10px); /* avoid overlap with home indicator */
}
#input-container input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px; /* prevents iOS automatic zoom */
  box-sizing: border-box;
}

/* new chat row */
#new-chat-container { display:flex; gap:6px; padding: 8px 10px; box-sizing:border-box; }

/* small screens adjustments */
@media (max-width: 480px) {
  /* use full width and remove rounded corners */
  #app-container { width: 100%; border-radius: 0; box-shadow:none; margin:0; }
  header { font-size: 1rem; padding:10px; }
  #top-buttons { padding:6px 8px; }
}

/* accessibility */
button:focus, input:focus { outline: 2px solid rgba(79,142,247,0.3); outline-offset: 2px; }
</style>
</head>
<body>
<div id="app-container" role="application" aria-label="AI Mentor app">
  <header>AI Mentor</header>

  <div id="top-buttons">
    <button id="btn-logout" class="top-btn" onclick="mainModule.logout()">Logout</button>
  </div>

  <div id="auth-container">
    <div class="auth-tabs">
      <button id="login-tab" class="active" onclick="authModule.showForm('login')">Login</button>
      <button id="register-tab" onclick="authModule.showForm('register')">Sign Up</button>
    </div>
    <form id="login-form" class="auth-form">
      <input type="email" id="login-email" placeholder="Email" required>
      <input type="password" id="login-password" placeholder="Password" required>
      <button type="button" onclick="authModule.login()">Login</button>
    </form>
    <form id="register-form" class="auth-form hidden" style="display:none;">
      <input type="email" id="register-email" placeholder="Email" required>
      <input type="password" id="register-password" placeholder="Password" required>
      <button type="button" onclick="authModule.register()">Create Account</button>
    </form>
  </div>

  <div id="chat-ui" class="hidden" aria-hidden="true">
    <div id="chat-dropdown-container">
      <div id="chat-dropdown-btn" onclick="toggleChatList()">Select Chat</div>
      <div id="chat-list"></div>
    </div>

    <div id="new-chat-container">
      <input type="text" id="new-chat-title" placeholder="New chat name">
      <button onclick="chatModule.createChat()">Create</button>
    </div>
    <button id="delete-chat-btn" onclick="chatModule.deleteChat()">Delete Chat</button>

    <div class="chat-area">
      <div id="chat-container" class="chat-container" role="log" aria-live="polite"></div>

      <div id="quick-buttons" aria-hidden="false"></div>

      <div id="input-wrapper">
        <div id="input-container">
          <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" inputmode="text" />
          <button id="send-btn" onclick="chatModule.sendMessage()">Send</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== DYNAMIC VH FIX (very important for iOS keyboard issues) =====
   Sets --vh CSS variable based on window.innerHeight so CSS can use calc(var(--vh)*100)
*/
(function initVh() {
  function setVh() {
    document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
  }
  setVh();
  window.addEventListener('resize', () => {
    // small debounce
    clearTimeout(window._vh_timeout);
    window._vh_timeout = setTimeout(setVh, 150);
  });
})();

/* ===== Utilities for iOS keyboard behavior ===== */
function safeScrollIntoView(el) {
  if (!el) return;
  // small delay to let virtual keyboard settle
  setTimeout(() => {
    try {
      el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    } catch (e) {
      el.scrollIntoView();
    }
  }, 150);
}

/* ===== MAIN MODULE (unchanged logic but referencing DOM refs) ===== */
const mainModule = (() => {
  let token = null, user_id = null, current_chat_id = null;
  const chatContainer = document.getElementById("chat-container");
  const quickButtonsDiv = document.getElementById("quick-buttons");
  const inputField = document.getElementById("message-input");
  const chatListDiv = document.getElementById("chat-list");
  const chatDropdownBtn = document.getElementById("chat-dropdown-btn");

  function setToken(t) { token = t; localStorage.setItem('token', t); }
  function setUserId(id) { user_id = id; localStorage.setItem('user_id', id); }
  function setCurrentChatId(id) {
      current_chat_id = id;
      if (chatDropdownBtn && chatListDiv) {
          const label = chatListDiv.querySelector(`[data-id='${id}']`);
          chatDropdownBtn.textContent = label ? label.textContent : "Select Chat";
          chatListDiv.classList.remove("show");
      }
  }
  function getToken() { return token; }
  function getUserId() { return user_id; }
  function getCurrentChatId() { return current_chat_id; }

  function logout() {
      token = null; user_id = null; current_chat_id = null;
      localStorage.removeItem('token');
      localStorage.removeItem('user_id');
      const chatUi = document.getElementById("chat-ui");
      const authContainer = document.getElementById("auth-container");
      if (chatUi) chatUi.classList.add("hidden");
      if (authContainer) authContainer.style.display = "block";
      if (chatContainer) chatContainer.innerHTML = "";
      if (quickButtonsDiv) quickButtonsDiv.innerHTML = "";
      if (chatListDiv) chatListDiv.innerHTML = "";
      if (chatDropdownBtn) chatDropdownBtn.textContent = "Select Chat";
      authModule.showForm('login');
  }

  return {
      setToken, setUserId, setCurrentChatId,
      getToken, getUserId, getCurrentChatId,
      logout, chatContainer, quickButtonsDiv, inputField, chatListDiv
  };
})();

/* ===== CHAT MODULE ===== */
const chatModule = (() => {

  async function fetchChats() {
      try {
          const res = await fetch(`/chats`, {
              headers: { Authorization: "Bearer " + mainModule.getToken() }
          });
          if (!res.ok) throw new Error('Fetch chats failed');
          const data = await res.json();
          const chatListDiv = mainModule.chatListDiv;
          if (!chatListDiv) return;
          chatListDiv.innerHTML = "";
          (data.chats || []).forEach(chat => {
              const div = document.createElement("div");
              div.textContent = chat.title;
              div.dataset.id = chat.id;
              div.onclick = () => {
                  mainModule.setCurrentChatId(chat.id);
                  fetchHistory();
                  quickButtonsModule.fetchQuickButtons();
              };
              chatListDiv.appendChild(div);
          });
      } catch (e) {
          console.error(e);
      }
  }

  async function createChat() {
      const titleEl = document.getElementById("new-chat-title");
      const title = titleEl ? titleEl.value.trim() : "";
      if (!title) return;
      try {
          const res = await fetch(`/chats`, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + mainModule.getToken()
              },
              body: JSON.stringify({ title })
          });
          const data = await res.json();
          if (titleEl) titleEl.value = "";
          await fetchChats();
          mainModule.setCurrentChatId(data.chat_id);
      } catch (e) {
          console.error(e);
          alert("Error creating chat");
      }
  }

  async function fetchHistory() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;
      try {
          const res = await fetch(`/history/${chatId}`, {
              headers: { Authorization: "Bearer " + mainModule.getToken() }
          });
          if (!res.ok) throw new Error("Failed to load history");
          const data = await res.json();
          if (mainModule.chatContainer) mainModule.chatContainer.innerHTML = "";
          (data.messages || []).forEach(msg => addMessage(msg.text, msg.sender, msg.created_at || msg.timestamp));
          scrollChatToBottom(true);
      } catch (e) {
          console.error("Error fetching history:", e);
      }
  }

  function addMessage(text, sender, timestamp = null) {
      if (!mainModule.chatContainer) return;
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${sender}`;
      msgDiv.textContent = text + (timestamp ? ` (${timestamp})` : '');
      mainModule.chatContainer.appendChild(msgDiv);
      scrollChatToBottom();
      return msgDiv;
  }

  async function typeWriterEffect(element, text, delay = 12) {
      element.textContent = "";
      for (let i = 0; i < text.length; i++) {
          element.textContent += text.charAt(i);
          scrollChatToBottom();
          await new Promise(r => setTimeout(r, delay));
      }
  }

  async function sendMessage(predefined = null) {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) {
          alert("Please select a chat first!");
          return;
      }
      const input = mainModule.inputField;
      const text = predefined || (input ? input.value.trim() : "");
      if (!text) return;

      addMessage(text, "user");
      if (input) input.value = "";

      const typingDiv = addMessage("AI is typing", "ai");
      if (typingDiv) typingDiv.classList.add("typing");

      let dots = 0;
      const typingInterval = setInterval(() => {
          dots = (dots + 1) % 4;
          if (typingDiv) typingDiv.textContent = "AI is typing" + '.'.repeat(dots);
      }, 400);

      try {
          const res = await fetch("/coach", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + mainModule.getToken()
              },
              body: JSON.stringify({
                  chat_id: chatId,
                  user_id: mainModule.getUserId(),
                  text
              })
          });

          if (!res.ok) throw new Error("Server error");
          const data = await res.json();
          clearInterval(typingInterval);
          if (typingDiv) {
              typingDiv.classList.remove("typing");
              await typeWriterEffect(typingDiv, data.reply || "(Empty response)");
          }
      } catch (err) {
          clearInterval(typingInterval);
          if (typingDiv) {
              typingDiv.classList.remove("typing");
              typingDiv.textContent = "Error receiving response";
          }
          console.error("Error sending message:", err);
      }
  }

  async function deleteChat() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;
      if (!confirm("Are you sure you want to delete this chat?")) return;
      try {
          await fetch(`/chats/${chatId}`, {
              method: "DELETE",
              headers: { Authorization: "Bearer " + mainModule.getToken() }
          });
          mainModule.setCurrentChatId(null);
          if (mainModule.chatContainer) mainModule.chatContainer.innerHTML = "";
          if (mainModule.chatListDiv) mainModule.chatListDiv.innerHTML = "";
          await fetchChats();
      } catch (e) {
          alert("Error deleting chat");
          console.error(e);
      }
  }

  function scrollChatToBottom(force = false) {
      const container = mainModule.chatContainer;
      if (!container) return;
      // If user near bottom or forcing, scroll; prevents fighting with user's manual scroll
      container.scrollTop = container.scrollHeight;
  }

  // on focus of input, ensure chat area is visible (important for iOS)
  if (mainModule.inputField) {
      mainModule.inputField.addEventListener('focus', (ev) => {
          safeScrollIntoView(mainModule.inputField);
          // also scroll chat to bottom
          setTimeout(() => scrollChatToBottom(true), 200);
      });
  }

  return { fetchChats, fetchHistory, addMessage, sendMessage, deleteChat, createChat };
})();

/* ===== QUICK BUTTONS MODULE (unchanged) ===== */
const quickButtonsModule = (() => {
  async function fetchQuickButtons() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;
      try {
          const res = await fetch(`/quick_buttons`, {
              headers: { Authorization: "Bearer " + mainModule.getToken() }
          });
          const data = await res.json();
          if (!mainModule.quickButtonsDiv) return;
          mainModule.quickButtonsDiv.innerHTML = "";
          (data.buttons || []).forEach(btn => {
              const button = document.createElement("button");
              button.className = "quick-btn";
              button.textContent = btn;
              button.onclick = () => chatModule.sendMessage(btn);

              const deleteBtn = document.createElement("button");
              deleteBtn.className = "delete-btn";
              deleteBtn.textContent = "×";
              deleteBtn.onclick = async e => {
                  e.stopPropagation();
                  await fetch(`/quick_buttons`, {
                      method: "DELETE",
                      headers: {
                          "Content-Type": "application/json",
                          Authorization: "Bearer " + mainModule.getToken()
                      },
                      body: JSON.stringify({ text: btn })
                  });
                  fetchQuickButtons();
              };

              button.appendChild(deleteBtn);
              mainModule.quickButtonsDiv.appendChild(button);
          });
      } catch (e) {
          console.error("Error loading quick buttons", e);
      }
  }
  return { fetchQuickButtons };
})();

/* ===== AUTH MODULE (unchanged logic) ===== */
const authModule = (() => {
  function showForm(type) {
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginTab = document.getElementById("login-tab");
      const registerTab = document.getElementById("register-tab");
      if (!loginForm || !registerForm) return;
      if (type === 'login') {
          loginForm.classList.remove("hidden");
          registerForm.classList.add("hidden");
          loginForm.style.display = "block";
          registerForm.style.display = "none";
          loginTab.classList.add("active");
          registerTab.classList.remove("active");
      } else {
          loginForm.classList.add("hidden");
          registerForm.classList.remove("hidden");
          loginForm.style.display = "none";
          registerForm.style.display = "block";
          loginTab.classList.remove("active");
          registerTab.classList.add("active");
      }
  }

  async function register() {
      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;
      try {
          const res = await fetch("/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password })
          });
          if (res.ok) {
              alert("Registration successful! Please login.");
              showForm("login");
          } else {
              const err = await res.json();
              alert("Error: " + (err.detail || res.statusText));
          }
      } catch (e) {
          alert("Registration error");
          console.error(e);
      }
  }

  async function login() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
          const res = await fetch("/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password })
          });
          if (res.ok) {
              const data = await res.json();
              mainModule.setToken(data.access_token);
              mainModule.setUserId(data.user_id);
              const authContainer = document.getElementById("auth-container");
              const chatUi = document.getElementById("chat-ui");
              if (authContainer) authContainer.style.display = "none";
              if (chatUi) {
                chatUi.classList.remove("hidden");
                chatUi.setAttribute('aria-hidden', 'false');
              }
              chatModule.fetchChats();
          } else {
              alert("Invalid email or password");
          }
      } catch (e) {
          alert("Login error");
          console.error(e);
      }
  }

  return { showForm, register, login };
})();

/* ===== Language utils & toggle ===== */
function setLanguage(lang) {
  const loginTab = document.getElementById("login-tab");
  const registerTab = document.getElementById("register-tab");
  if (loginTab) loginTab.textContent = lang === 'ru' ? "Вход" : "Login";
  if (registerTab) registerTab.textContent = lang === 'ru' ? "Регистрация" : "Register";
  const loginBtn = document.querySelector("#login-form button");
  const regBtn = document.querySelector("#register-form button");
  if (loginBtn) loginBtn.textContent = lang === 'ru' ? "Войти" : "Login";
  if (regBtn) regBtn.textContent = lang === 'ru' ? "Зарегистрироваться" : "Create Account";
  const input = document.getElementById("message-input");
  if (input) input.placeholder = lang === 'ru' ? "Напиши сообщение..." : "Type your message...";
}

function toggleChatList() {
  const list = document.getElementById("chat-list");
  const btn = document.getElementById("chat-dropdown-btn");
  if (!list || !btn) return;
  const isOpen = list.classList.toggle("show");
  btn.classList.toggle("open", isOpen);
}

/* ===== INIT ===== */
window.addEventListener('DOMContentLoaded', () => {
  const authContainer = document.getElementById("auth-container");
  if (authContainer) authContainer.style.display = "block";
  authModule.showForm('login');
  setLanguage('en');
  const storedToken = localStorage.getItem('token');
  const storedUser = localStorage.getItem('user_id');
  if (storedToken && storedUser) {
      mainModule.setToken(storedToken);
      mainModule.setUserId(storedUser);
      const chatUi = document.getElementById("chat-ui");
      if (chatUi) {
        chatUi.classList.remove("hidden");
        chatUi.setAttribute('aria-hidden', 'false');
      }
      if (authContainer) authContainer.style.display = "none";
      chatModule.fetchChats();
  }
});

/* ===== ENTER to SEND ===== */
document.addEventListener('keypress', function (e) {
  const msgInput = document.getElementById("message-input");
  if (!msgInput) return;
  if (e.key === "Enter" && !e.shiftKey && document.activeElement === msgInput) {
      e.preventDefault();
      chatModule.sendMessage();
  }
});
</script>
</body>
</html>
