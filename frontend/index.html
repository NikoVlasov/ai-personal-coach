<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mentor ‚Äì Your Personal AI Coach</title>

    <!-- === Meta & SEO === -->
    <meta name="description" content="AI Mentor is your personal AI coach to help you grow, stay motivated, and improve your daily routines.">
    <meta name="keywords" content="AI Mentor, personal coach, AI assistant, productivity, motivation">
    <meta name="author" content="AI Mentor Team">

    <!-- === Favicon === -->
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">

    <!-- === OpenGraph (LinkedIn / Facebook preview) === -->
    <meta property="og:title" content="AI Mentor ‚Äì Your Personal AI Coach">
    <meta property="og:description" content="Boost your productivity and motivation with AI Mentor. Your personal AI coach, available anytime.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ai-personal-coach-rogv.onrender.com">
    <meta property="og:image" content="https://ai-personal-coach-rogv.onrender.com/static/og-preview.png">
    <meta property="og:site_name" content="AI Mentor">

    <!-- === Twitter Card === -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Mentor ‚Äì Your Personal AI Coach">
    <meta name="twitter:description" content="Boost your productivity and motivation with AI Mentor. Your personal AI coach, available anytime.">
    <meta name="twitter:image" content="https://ai-personal-coach-rogv.onrender.com/static/og-preview.png">

    <!-- === Tailwind CSS === -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

<style>
/* === Global styles === */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* ‚õî body –ù–ï —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è */
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
}

/* === APP CONTAINER === */
#app-container {
    width: 420px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin: 10px;
    box-sizing: border-box;

    height: calc(var(--vh, 1vh) * 100);
}

/* === HEADER === */
header {
    background-color: #4f8ef7;
    color: white;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
    padding: 15px;
    flex-shrink: 0;
}

.hidden { display: none; }

/* === TOP BUTTONS === */
#top-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 10px;
    flex-shrink: 0;
}

/* === CHAT === */
#chat-container {
    flex: 1;                 /* üî• –ì–õ–ê–í–ù–û–ï */
    min-height: 0;           /* üî• –ì–õ–ê–í–ù–û–ï */
    overflow-y: auto;        /* ‚úÖ –¢–û–õ–¨–ö–û –¢–£–¢ –°–ö–†–û–õ–õ */
    -webkit-overflow-scrolling: touch;

    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;

    background: linear-gradient(180deg, #e9f0fb, #dde7f5);
}

/* === MESSAGES === */
.message {
    max-width: 75%;
    padding: 10px 15px;
    border-radius: 15px;
    line-height: 1.4;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.user {
    background: #4f8ef7;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
}

.ai {
    background: #fff;
    color: #333;
    align-self: flex-start;
    border: 1px solid #ccc;
    border-bottom-left-radius: 0;
}

/* === QUICK BUTTONS === */
#quick-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    background: #f0f4fb;
    border-top: 1px solid #ccc;
    flex-shrink: 0;
}

/* === INPUT === */
#input-container {
    display: flex;
    gap: 5px;
    padding: 10px;
    flex-shrink: 0;
}

#input-container input {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

#input-container button {
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    background: #4f8ef7;
    color: white;
    font-weight: bold;
}

/* === MOBILE FIX === */
@media (max-width: 480px) {
    input, button {
        font-size: 16px !important;
    }
}
</style>


</head>
<body>
    <div id="app-container">
        <header>AI Mentor</header>

        <div id="top-buttons">
            <button id="btn-logout" class="top-btn" onclick="mainModule.logout()">Logout</button>
        </div>

        <!-- Authentication -->
        <div id="auth-container">
            <div class="auth-tabs">
                <button id="login-tab" class="active" onclick="authModule.showForm('login')">Login</button>
                <button id="register-tab" onclick="authModule.showForm('register')">Sign Up</button>
            </div>

            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="button" onclick="authModule.login()">Login</button>
            </form>

            <form id="register-form" class="auth-form hidden">
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="button" onclick="authModule.register()">Create Account</button>
            </form>
        </div>

        <!-- Chat UI -->
        <div id="chat-ui" class="hidden">
            <div id="chat-dropdown-container">
                <div id="chat-dropdown-btn" onclick="toggleChatList()">Select Chat</div>
                <div id="chat-list"></div>
            </div>

            <div id="new-chat-container">
                <input type="text" id="new-chat-title" placeholder="New chat name">
                <button onclick="chatModule.createChat()">Create</button>
            </div>

            <button id="delete-chat-btn" onclick="chatModule.deleteChat()">Delete Chat</button>

            <div id="chat-container"></div>
            <div id="quick-buttons"></div>

            <div id="input-container">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button onclick="chatModule.sendMessage()">Send</button>



            </div>

        </div>
    </div>


<script>
  // ===== VIEWPORT HEIGHT FIX =====
  function updateViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  updateViewportHeight();
  window.addEventListener('resize', updateViewportHeight);
  window.addEventListener('orientationchange', updateViewportHeight);

  // ===== MAIN MODULE =====
  const mainModule = (() => {
    let token = null;
    let user_id = null;
    let current_chat_id = null;

    const chatContainer = document.getElementById("chat-container");
    const quickButtonsDiv = document.getElementById("quick-buttons");
    const inputField = document.getElementById("message-input");
    const chatListDiv = document.getElementById("chat-list");
    const chatDropdownBtn = document.getElementById("chat-dropdown-btn");

    function setToken(t) {
      token = t;
      localStorage.setItem('token', t);
    }

    function setUserId(id) {
      user_id = id;
      localStorage.setItem('user_id', id);
    }

    function setCurrentChatId(id) {
      current_chat_id = id;
      if (chatDropdownBtn && chatListDiv) {
        const label = chatListDiv.querySelector(`[data-id='${id}']`);
        chatDropdownBtn.textContent = label ? label.textContent : "Select Chat";
        chatListDiv.classList.remove("show");
      }
    }

    function getToken() { return token; }
    function getUserId() { return user_id; }
    function getCurrentChatId() { return current_chat_id; }

    function logout() {
      token = null;
      user_id = null;
      current_chat_id = null;
      localStorage.removeItem('token');
      localStorage.removeItem('user_id');

      const chatUi = document.getElementById("chat-ui");
      const authContainer = document.getElementById("auth-container");

      if (chatUi) chatUi.classList.add("hidden");
      if (authContainer) authContainer.style.display = "block";
      if (chatContainer) chatContainer.innerHTML = "";
      if (quickButtonsDiv) quickButtonsDiv.innerHTML = "";
      if (chatListDiv) chatListDiv.innerHTML = "";
      if (chatDropdownBtn) chatDropdownBtn.textContent = "Select Chat";

      authModule.showForm('login');
    }

    return {
      setToken,
      setUserId,
      setCurrentChatId,
      getToken,
      getUserId,
      getCurrentChatId,
      logout,
      chatContainer,
      quickButtonsDiv,
      inputField,
      chatListDiv
    };
  })();

  // ===== CHAT MODULE =====
  const chatModule = (() => {
    async function fetchChats() {
      try {
        const res = await fetch("/chats", {
          headers: { Authorization: "Bearer " + mainModule.getToken() }
        });
        const data = await res.json();
        const chatListDiv = mainModule.chatListDiv;
        if (!chatListDiv) return;

        chatListDiv.innerHTML = "";
        data.chats.forEach(chat => {
          const div = document.createElement("div");
          div.textContent = chat.title;
          div.dataset.id = chat.id;
          div.onclick = () => {
            mainModule.setCurrentChatId(chat.id);
            fetchHistory();
            quickButtonsModule.fetchQuickButtons();
          };
          chatListDiv.appendChild(div);
        });
      } catch (e) {
        alert("Error fetching chats");
        console.error(e);
      }
    }

    async function createChat() {
      const title = document.getElementById("new-chat-title").value.trim();
      if (!title) return;
      try {
        const res = await fetch("/chats", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + mainModule.getToken()
          },
          body: JSON.stringify({ title })
        });
        const data = await res.json();
        document.getElementById("new-chat-title").value = "";
        await fetchChats();
        mainModule.setCurrentChatId(data.chat_id);
      } catch (e) {
        alert("Error creating chat");
        console.error(e);
      }
    }

    async function fetchHistory() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;
      try {
        const res = await fetch(`/history/${chatId}`, {
          headers: { Authorization: "Bearer " + mainModule.getToken() }
        });
        if (!res.ok) throw new Error("Failed to load history");
        const data = await res.json();
        if (mainModule.chatContainer) mainModule.chatContainer.innerHTML = "";
        data.messages.forEach(msg =>
          addMessage(msg.text, msg.sender, msg.created_at || msg.timestamp)
        );
        scrollChatToBottom();
      } catch (e) {
        console.error("Error fetching history:", e);
      }
    }

    function addMessage(text, sender, timestamp = null) {
      if (!mainModule.chatContainer) return;
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${sender}`;
      msgDiv.textContent = text;
      mainModule.chatContainer.appendChild(msgDiv);
      scrollChatToBottom();
      return msgDiv;
    }

    async function typeWriterEffect(element, text, delay = 16) {
      element.textContent = "";
      for (let i = 0; i < text.length; i++) {
        element.textContent += text.charAt(i);
        scrollChatToBottom();
        await new Promise(r => setTimeout(r, delay));
      }
    }

    async function sendMessage(predefined = null) {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) {
        alert("Please select a chat first!");
        return;
      }
      const input = mainModule.inputField;
      const text = predefined || (input ? input.value.trim() : "");
      if (!text) return;

      addMessage(text, "user");
      setHeaderState("thinking");
      if (input) input.value = "";

      const typingDiv = addMessage("AI is typing", "ai");
      if (typingDiv) typingDiv.classList.add("typing");

      let dots = 0;
      const typingInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        if (typingDiv) typingDiv.textContent = "AI is typing" + '.'.repeat(dots);
      }, 400);

      try {
        const res = await fetch("/coach", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + mainModule.getToken()
          },
          body: JSON.stringify({
            chat_id: chatId,
            user_id: mainModule.getUserId(),
            text
          })
        });

        if (!res.ok) throw new Error("Server error");
        const data = await res.json();
        clearInterval(typingInterval);
        if (typingDiv) {
          typingDiv.classList.remove("typing");
          await typeWriterEffect(typingDiv, data.reply || "(Empty response)");
          setHeaderState("reply");
        }
      } catch (err) {
        clearInterval(typingInterval);
        if (typingDiv) {
          typingDiv.classList.remove("typing");
          typingDiv.textContent = "Error receiving response";
        }
        console.error("Error sending message:", err);
        setHeaderState("idle");
      }
    }

    async function deleteChat() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;
      if (!confirm("Are you sure you want to delete this chat?")) return;

      try {
        await fetch(`/chats/${chatId}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + mainModule.getToken() }
        });
        mainModule.setCurrentChatId(null);
        if (mainModule.chatContainer) mainModule.chatContainer.innerHTML = "";
        if (mainModule.chatListDiv) mainModule.chatListDiv.innerHTML = "";
        await fetchChats();
      } catch (e) {
        alert("Error deleting chat");
        console.error(e);
      }
    }

    function scrollChatToBottom() {
      const container = mainModule.chatContainer;
      if (!container) return;
      container.scrollTop = container.scrollHeight;
    }

    return { fetchChats, fetchHistory, addMessage, sendMessage, deleteChat, createChat };
  })();

  // ===== QUICK BUTTONS MODULE =====
  const quickButtonsModule = (() => {
    async function fetchQuickButtons() {
      const chatId = mainModule.getCurrentChatId();
      if (!chatId) return;

      try {
        const res = await fetch("/quick_buttons", {
          headers: { Authorization: "Bearer " + mainModule.getToken() }
        });
        const data = await res.json();
        if (!mainModule.quickButtonsDiv) return;

        mainModule.quickButtonsDiv.innerHTML = "";
        data.buttons.forEach(btn => {
          const button = document.createElement("button");
          button.className = "quick-btn";
          button.textContent = btn;
          button.onclick = () => chatModule.sendMessage(btn);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "√ó";
          deleteBtn.onclick = async e => {
            e.stopPropagation();
            await fetch("/quick_buttons", {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + mainModule.getToken()
              },
              body: JSON.stringify({ text: btn })
            });
            fetchQuickButtons();
          };

          button.appendChild(deleteBtn);
          mainModule.quickButtonsDiv.appendChild(button);
        });
      } catch (e) {
        console.error("Error loading quick buttons", e);
      }
    }

    return { fetchQuickButtons };
  })();

  // ===== AUTH MODULE =====
  const authModule = (() => {
    function showForm(type) {
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginTab = document.getElementById("login-tab");
      const registerTab = document.getElementById("register-tab");
      if (!loginForm || !registerForm) return;

      if (type === 'login') {
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        loginTab.classList.add("active");
        registerTab.classList.remove("active");
      } else {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        loginTab.classList.remove("active");
        registerTab.classList.add("active");
      }
    }

    async function register() {
      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;
      try {
        const res = await fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (res.ok) {
          alert("Registration successful! Please login.");
          showForm("login");
        } else {
          const err = await res.json();
          alert("Error: " + (err.detail || res.statusText));
        }
      } catch (e) {
        alert("Registration error");
        console.error(e);
      }
    }

    async function login() {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (res.ok) {
          const data = await res.json();
          mainModule.setToken(data.access_token);
          mainModule.setUserId(data.user_id);

          const authContainer = document.getElementById("auth-container");
          const chatUi = document.getElementById("chat-ui");
          if (authContainer) authContainer.style.display = "none";
          if (chatUi) chatUi.classList.remove("hidden");

          chatModule.fetchChats();
        } else {
          alert("Invalid email or password");
        }
      } catch (e) {
        alert("Login error");
        console.error(e);
      }
    }

    return { showForm, register, login };
  })();

  // ===== UTILS =====
  function setLanguage(lang) {
    const loginTab = document.getElementById("login-tab");
    const registerTab = document.getElementById("register-tab");
    if (loginTab) loginTab.textContent = lang === 'ru' ? "–í—Ö–æ–¥" : "Login";
    if (registerTab) registerTab.textContent = lang === 'ru' ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "Register";

    const loginBtn = document.querySelector("#login-form button");
    const regBtn = document.querySelector("#register-form button");
    if (loginBtn) loginBtn.textContent = lang === 'ru' ? "–í–æ–π—Ç–∏" : "Login";
    if (regBtn) regBtn.textContent = lang === 'ru' ? "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" : "Create Account";

    const input = document.getElementById("message-input");
    if (input) input.placeholder = lang === 'ru' ? "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." : "Type your message...";
  }

  function setHeaderState(state) {
    const header = document.querySelector("header");
    if (!header) return;

    if (state === "idle") {
      header.textContent = "AI Mentor";
    } else if (state === "thinking") {
      header.textContent = "Thinking‚Ä¶ ü§î";
    } else if (state === "reply") {
      header.textContent = "Here‚Äôs my thought üí°";
    }
  }

  function toggleChatList() {
    const list = document.getElementById("chat-list");
    const btn = document.getElementById("chat-dropdown-btn");
    if (!list || !btn) return;
    const isOpen = list.classList.toggle("show");
    btn.classList.toggle("open", isOpen);
  }

  // ===== INIT =====
  window.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById("auth-container");
    if (authContainer) authContainer.style.display = "block";

    authModule.showForm('login');
    setLanguage('en');

    const storedToken = localStorage.getItem('token');
    const storedUser = localStorage.getItem('user_id');

    if (storedToken && storedUser) {
      mainModule.setToken(storedToken);
      mainModule.setUserId(storedUser);

      const chatUi = document.getElementById("chat-ui");
      if (chatUi) chatUi.classList.remove("hidden");
      if (authContainer) authContainer.style.display = "none";

      chatModule.fetchChats();
    }
  });

  // ===== MOBILE KEYBOARD FIX (iOS + Android) =====
  function scrollInputIntoView() {
    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
      const chatContainer = document.getElementById('chat-container');
      if (!chatContainer) return;

      const rect = active.getBoundingClientRect();
      const containerRect = chatContainer.getBoundingClientRect();
      const offset = rect.bottom - containerRect.bottom + 10;
      if (offset > 0) {
        chatContainer.scrollBy({ top: offset, behavior: 'smooth' });
      }
    }
  }

  window.addEventListener('resize', scrollInputIntoView);
  window.visualViewport?.addEventListener('resize', scrollInputIntoView);
  document.addEventListener('focusin', scrollInputIntoView);

  // ===== ENTER TO SEND =====
  const msgInput = document.getElementById("message-input");
  if (msgInput) {
    msgInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatModule.sendMessage();
      }
    });
  }
</script>
</body>
</html>



